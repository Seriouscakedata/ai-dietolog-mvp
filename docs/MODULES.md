# Обзор модулей и агентов

Этот документ описывает архитектуру проекта и роли отдельных компонентов.

## Общая структура

Проект состоит из трёх основных пакетов:

- **ai_dietolog.bot** – взаимодействие с Telegram и сценарии общения.
- **ai_dietolog.agents** – "умные" помощники, которые обращаются к LLM и формируют данные.
- **ai_dietolog.core** – конфигурация, модели данных, подсчёты и утилиты работы с LLM.

Данные пользователей сохраняются локально в каталоге `data/<tg_user_id>` в формате JSON.

## Агенты (`ai_dietolog/agents`)

Каждый агент использует `core.llm.ask_llm` и шаблоны из `core.prompts`. Настройки провайдера и модели берутся из `core.config.agent_llm`.

- **intake.py** – преобразует текст и/или фото блюда в объект `Meal`. Применяется в обработчике `meal_logging`.
- **meal_editor.py** – корректирует существующее блюдо по комментарию пользователя.
- **contextual.py** – анализирует новый приём пищи в контексте профиля и уже съеденного за день. Возвращает обновлённую сводку и комментарий.
- **daily_review.py** – генерирует текстовый обзор дня по итоговым значениям и списку приёмов пищи.
- **norms_ai.py** – рассчитывает пищевые нормы через LLM. Используется `profile_collector`, если в конфигурации включён флаг `use_llm_norms`.
- **profile_collector.py** – строит `Profile` из ответов пользователя, используя `core.logic` или `norms_ai`.
- **profile_editor.py** – вносит правки в существующий профиль на основе свободного текста пользователя.

## Обработчики Telegram (`ai_dietolog/bot/handlers`)

- **profile_setup.py** – диалог для создания и редактирования профиля. Вызывает `profile_collector` и `profile_editor`.
- **meal_logging.py** – добавление, редактирование и комментирование приёмов пищи. Использует `intake`, `meal_editor` и `contextual`.
- **daily_review.py** – закрытие дня и сохранение истории. Для итогового комментария обращается к агенту `daily_review`.

## Core (`ai_dietолог/core`)

- **config.py** – чтение `config.json`, выбор LLM‑провайдера и модели для каждого агента.
- **llm.py** – унифицированный интерфейс работы с OpenAI и Google Gemini.
- **logic.py** – расчёт норм (БЖУ, калории и т. д.).
- **schema.py** – Pydantic‑модели: `Profile`, `Meal`, `Today`, `History` и др.
- **storage.py** – чтение/запись JSON с блокировками файлов.
- **prompts.py / prompts.yaml** – шаблоны подсказок для LLM.

## Зависимости

Основные внешние библиотеки перечислены в `requirements.txt`:

- `python-telegram-bot` – Telegram Bot API.
- `openai`, `google-generativeai` – провайдеры LLM.
- `pydantic`, `filelock`, `jinja2`, `pyyaml`, `colorama`, `apscheduler` и др.

Эти зависимости позволяют боту общаться с пользователем, формировать подсказки для моделей и безопасно хранить локальные данные.
